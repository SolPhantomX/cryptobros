<script>
  let profileData = JSON.parse(localStorage.getItem('profileData')) || { name: '', about: '', city: '' };
  let headerPos = JSON.parse(localStorage.getItem('headerPos')) || { x: 0, y: 0 };
  let isProfileSaved = !!localStorage.getItem('profileData');
  let currentBg = localStorage.getItem('pageBg') || 'bg3.jpg';
  let customBg = localStorage.getItem('customBg');

  function applyBackground() {
    if (customBg) {
      document.body.style.backgroundImage = `url(${customBg})`;
    } else {
      document.body.style.backgroundImage = `url('https://raw.githubusercontent.com/SolPhantomX/cryptobros/main/${currentBg}')`;
    }
  }

  function init() {
    const headerImg = localStorage.getItem('header') || 'https://raw.githubusercontent.com/SolPhantomX/cryptobros/main/header.jpg';
    const avatarImg = localStorage.getItem('avatar') || 'https://raw.githubusercontent.com/SolPhantomX/cryptobros/main/avatar.png';
    
    const headerEl = document.getElementById('header');
    headerEl.style.backgroundImage = `url(${headerImg})`;
    headerEl.style.backgroundSize = 'auto';
    headerEl.style.backgroundRepeat = 'no-repeat';
    document.getElementById('avatar').style.backgroundImage = `url(${avatarImg})`;
    headerEl.style.backgroundPosition = `${headerPos.x}px ${headerPos.y}px`;
    
    if (localStorage.getItem('header')) {
      headerEl.classList.add('loaded');
    }

    applyBackground();
    renderViewMode();
    buildEditMenu();

    // Включаем drag ТОЛЬКО если профиль НЕ сохранён
    if (!isProfileSaved) {
      setupDragToPan();
    }
  }

  function setupDragToPan() {
    let isDragging = false;
    const headerEl = document.getElementById('header');
    
    headerEl.addEventListener('mousedown', e => {
      isDragging = true;
      const rect = headerEl.getBoundingClientRect();
      const bgPos = getComputedStyle(headerEl).backgroundPosition.split(' ');
      let startX = parseFloat(bgPos[0]) || 0;
      let startY = parseFloat(bgPos[1]) || 0;
      
      const onMouseMove = ev => {
        if (!isDragging) return;
        const dx = ev.clientX - e.clientX;
        const dy = ev.clientY - e.clientY;
        headerPos.x = startX + dx;
        headerPos.y = startY + dy;
        headerEl.style.backgroundPosition = `${headerPos.x}px ${headerPos.y}px`;
      };

      const onMouseUp = () => {
        isDragging = false;
        document.body.style.cursor = 'default';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        localStorage.setItem('headerPos', JSON.stringify(headerPos));
      };

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.body.style.cursor = 'grabbing';
    });
  }

  function renderViewMode() {
    const el = document.getElementById('profileContent');
    el.innerHTML = `
      <div class="name">@cryptobros</div>
      <div class="rank">Degen (Master)</div>
      ${profileData.name ? `<div class="field-label">Full Name</div><div class="field-value">${profileData.name}</div>` : ''}
      ${profileData.about ? `<div class="field-label">About</div><div class="field-value">${profileData.about}</div>` : ''}
      ${profileData.city ? `<div class="field-label">City</div><div class="field-value">${profileData.city}</div>` : ''}
    `;
  }

  function renderEditMode() {
    const el = document.getElementById('profileContent');
    el.innerHTML = `
      <div class="name">@cryptobros</div>
      <div class="rank">Degen (Master)</div>
      
      <div class="field-label">Full Name</div>
      <input type="text" id="inpName" value="${profileData.name}" placeholder="Enter your name">
      
      <div class="field-label">About</div>
      <textarea id="inpAbout" placeholder="Tell us about yourself...">${profileData.about}</textarea>
      
      <div class="field-label">City</div>
      <input type="text" id="inpCity" value="${profileData.city}" placeholder="Your city">
      
      <button class="btn" onclick="saveProfile()">SAVE PROFILE</button>
    `;
  }

  function saveProfile() {
    profileData = {
      name: document.getElementById('inpName').value,
      about: document.getElementById('inpAbout').value,
      city: document.getElementById('inpCity').value
    };
    localStorage.setItem('profileData', JSON.stringify(profileData));
    isProfileSaved = true;
    renderViewMode();
    // Drag больше не включается
  }

  function buildEditMenu() {
    const names = ['Neural Core','Cyber Grid','Dark Void','Quantum Flow','Matrix','Solana Nexus','AI Tribunal','Crypto Void','Phantom Glow','DeFi Circuit','Token Storm','Web3 Horizon','Degen Realm'];
    let html = '<button onclick="toggleEdit()" style="display:inline-block;">Edit Profile</button>';
    html += '<button onclick="showBgMenu()" style="display:inline-block;">Choose Background</button>';
    document.getElementById('editMenu').innerHTML = html;
  }

  function showBgMenu() {
    const names = ['Neural Core','Cyber Grid','Dark Void','Quantum Flow','Matrix','Solana Nexus','AI Tribunal','Crypto Void','Phantom Glow','DeFi Circuit','Token Storm','Web3 Horizon','Degen Realm'];
    let html = '<div style="margin:4px 0;color:#666;font-size:12px;">Background:</div>';
    for (let i = 1; i <= 13; i++) {
      const sel = (currentBg === `bg${i}.jpg` && !customBg) ? ' style="color:#00ff9d;"' : '';
      html += `<button onclick="setBg('bg${i}.jpg')"${sel}>${names[i-1]}</button>`;
    }
    html += `<button onclick="document.getElementById('bg-upload').click()">+ Upload Custom</button>`;
    document.getElementById('editMenu').innerHTML = html;
    document.getElementById('editMenu').querySelectorAll('button').forEach(b => b.style.display = 'inline-block');
  }

  function setBg(bg) {
    currentBg = bg;
    customBg = null;
    localStorage.setItem('pageBg', bg);
    localStorage.removeItem('customBg');
    applyBackground();
    buildEditMenu();
  }

  document.getElementById('bg-upload').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) {
      const r = new FileReader();
      r.onload = ev => {
        customBg = ev.target.result;
        localStorage.setItem('customBg', customBg);
        applyBackground();
        buildEditMenu();
      };
      r.readAsDataURL(f);
    }
  });

  document.getElementById('header-upload').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) {
      const r = new FileReader();
      r.onload = ev => {
        document.getElementById('header').style.backgroundImage = `url(${ev.target.result})`;
        localStorage.setItem('header', ev.target.result);
        document.getElementById('header').classList.add('loaded');
        if (!isProfileSaved) {
          document.getElementById('header').style.backgroundPosition = `${headerPos.x}px ${headerPos.y}px`;
        }
      };
      r.readAsDataURL(f);
    }
  });

  document.getElementById('avatar-upload').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) {
      const r = new FileReader();
      r.onload = ev => {
        document.getElementById('avatar').style.backgroundImage = `url(${ev.target.result})`;
        localStorage.setItem('avatar', ev.target.result);
      };
      r.readAsDataURL(f);
    }
  });

  document.getElementById('header').onclick = () => document.getElementById('header-upload').click();
  document.getElementById('avatar').onclick = () => document.getElementById('avatar-upload').click();

  const btn = document.getElementById('editBtn');
  const tt = document.getElementById('editTooltip');
  const menu = document.getElementById('editMenu');
  btn.onmouseenter = () => tt.style.opacity = '1';
  btn.onmouseleave = () => tt.style.opacity = '0';
  btn.onclick = () => menu.style.display = menu.style.display === 'block' ? 'none' : 'block';

  function toggleEdit() {
    menu.style.display = 'none';
    renderEditMode();
    isProfileSaved = false; // ← разрешаем drag снова
    setupDragToPan(); // ← и включаем его
  }

  document.addEventListener('click', e => {
    if (!btn.contains(e.target) && !menu.contains(e.target)) {
      menu.style.display = 'none';
    }
  });

  window.onload = init;
</script>
