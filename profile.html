<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRYPTOBROS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: white;
    }
    .top-section {
      position: relative;
      height: 300px;
    }
    .header {
      width: 100%;
      height: 100%;
      background: center/cover no-repeat;
      border: 2px dashed #555;
      cursor: grab;
    }
    .header.dragging {
      cursor: grabbing;
    }
    .header.loaded {
      border: none;
    }
    .avatar {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 4px solid white;
      background: center/cover no-repeat;
      position: absolute;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      cursor: pointer;
    }
    .edit-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      background: #333;
      border: 1px solid #666;
      border-radius: 50%;
      color: #ffcc00;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
    }
    .edit-menu {
      position: absolute;
      top: 50px;
      right: 16px;
      background: #000;
      border: 1px solid #ffcc00;
      border-radius: 6px;
      padding: 8px;
      display: none;
      z-index: 100;
      min-width: 180px;
    }
    .edit-menu button {
      display: block;
      width: 100%;
      background: #222;
      color: #ffcc00;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 4px 0;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .sidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 200px;
    }
    .nav-item {
      padding: 10px 0;
      color: #385898;
      font-weight: bold;
      cursor: pointer;
    }
    .main {
      max-width: 800px;
      margin: 220px auto 0;
      padding: 0 20px;
    }
    .name, .rank, .field-value {
      color: #ffcc00;
      animation: flicker 3s infinite alternate;
    }
    @keyframes flicker {
      0%,19%,21%,23%,25%,54%,56%,80%,82%,84%,86%,100% { opacity:1; }
      20%,24%,55%,81%,85% { opacity:0.8; }
    }
    .name { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
    .rank { margin-bottom: 20px; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px;
      background: rgba(0,0,0,0.3);
      color: #ffcc00;
      border: 1px solid #555;
      border-radius: 4px;
    }
    .btn {
      background: #4267B2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    #bg-upload, #avatar-upload, #header-upload { display: none; }
  </style>
</head>
<body>

<div class="top-section">
  <div class="header" id="header"></div>
  <div class="avatar" id="avatar"></div>
  <div class="edit-btn" id="editBtn">⚙️</div>
  <div class="edit-menu" id="editMenu"></div>
</div>

<div class="sidebar">
  <div class="nav-item">News Feed</div>
  <div class="nav-item">Messages</div>
  <div class="nav-item">My Groups</div>
  <div class="nav-item">Tribunal</div>
  <div class="nav-item">My Friends</div>
</div>

<div class="main" id="profileContent">
  <div class="name">—</div>
  <div class="rank">Degen (Master)</div>
  <div class="field-label">About</div>
  <div class="field-value">—</div>
  <div class="field-label">City</div>
  <div class="field-value">—</div>
</div>

<input type="file" id="bg-upload" accept="image/*">
<input type="file" id="avatar-upload" accept="image/*">
<input type="file" id="header-upload" accept="image/*">

<script>
  // Готовим данные
  const bgList = Array.from({length: 13}, (_, i) => `bg${i + 1}.jpg`);
  let profileData = { name: '', about: '', city: '' };
  let headerPos = { x: 0, y: 0 };

  // Восстановление из localStorage
  function loadFromStorage() {
    try {
      const p = localStorage.getItem('profileData');
      if (p) profileData = JSON.parse(p);
      const hp = localStorage.getItem('headerPos');
      if (hp) headerPos = JSON.parse(hp);
    } catch (e) { console.warn('localStorage parse error'); }
  }

  // Сохранение
  function saveToStorage() {
    try {
      localStorage.setItem('profileData', JSON.stringify(profileData));
      localStorage.setItem('headerPos', JSON.stringify(headerPos));
    } catch (e) { console.warn('localStorage save error'); }
  }

  // Установка фона страницы
  function setBgDataURL(dataUrl) {
    document.body.style.backgroundImage = `url(${dataUrl})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundAttachment = 'fixed';
    localStorage.setItem('pageBg', dataUrl);
  }

  // Установка фона шапки
  function setHeaderDataURL(dataUrl) {
    const header = document.getElementById('header');
    header.style.backgroundImage = `url(${dataUrl})`;
    header.classList.add('loaded');
    localStorage.setItem('header', dataUrl);
  }

  // Установка аватара
  function setAvatarDataURL(dataUrl) {
    document.getElementById('avatar').style.backgroundImage = `url(${dataUrl})`;
    localStorage.setItem('avatar', dataUrl);
  }

  // Инициализация после загрузки DOM
  function init() {
    loadFromStorage();

    const header = document.getElementById('header');
    const avatar = document.getElementById('avatar');

    // Восстановление шапки
    const savedHeader = localStorage.getItem('header');
    if (savedHeader) setHeaderDataURL(savedHeader);
    header.style.backgroundPosition = `${headerPos.x}px ${headerPos.y}px`;

    // Восстановление аватара
    const savedAvatar = localStorage.getItem('avatar');
    if (savedAvatar) setAvatarDataURL(savedAvatar);

    // Восстановление фона страницы
    const savedBg = localStorage.getItem('pageBg');
    if (savedBg) setBgDataURL(savedBg);

    renderProfile();
    setupEvents();
  }

  function setupEvents() {
    const header = document.getElementById('header');
    let isDragging = false;
    let startX, startY, startXPx, startYPx;

    // Drag-to-pan
    header.addEventListener('mousedown', e => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      header.classList.add('dragging');

      const bgPos = getComputedStyle(header).backgroundPosition.split(' ');
      startXPx = parseFloat(bgPos[0]) || 0;
      startYPx = parseFloat(bgPos[1]) || 0;
    });

    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      headerPos.x = startXPx + dx;
      headerPos.y = startYPx + dy;
      header.style.backgroundPosition = `${headerPos.x}px ${headerPos.y}px`;
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        header.classList.remove('dragging');
        saveToStorage();
      }
    });

    // Клик по шапке → загрузка
    header.addEventListener('click', e => {
      if (!isDragging) {
        document.getElementById('header-upload').click();
      }
    });

    // Аватар
    avatar.addEventListener('click', () => {
      document.getElementById('avatar-upload').click();
    });

    // Шестерёнка
    document.getElementById('editBtn').addEventListener('click', () => {
      const menu = document.getElementById('editMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      if (menu.style.display === 'block') {
        menu.innerHTML = `
          <button onclick="showBgMenu()">Change Background</button>
          <button onclick="showEditProfile()">Edit Profile</button>
        `;
      }
    });

    // Закрытие меню
    document.addEventListener('click', e => {
      const btn = document.getElementById('editBtn');
      const menu = document.getElementById('editMenu');
      if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = 'none';
      }
    });

    // Upload handlers — через FileReader
    document.getElementById('header-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => setHeaderDataURL(reader.result);
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('avatar-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => setAvatarDataURL(reader.result);
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('bg-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => setBgDataURL(reader.result);
        reader.readAsDataURL(file);
      }
    });
  }

  function showBgMenu() {
    let buttons = bgList.map(bg => `<button onclick="loadBg('${bg}')">${bg}</button>`).join('');
    buttons += `<button onclick="document.getElementById('bg-upload').click()">Upload Custom</button>`;
    document.getElementById('editMenu').innerHTML = `
      <div style="color:#ffcc00;margin-bottom:8px;">Page Background</div>
      <div style="display:flex;flex-direction:column;gap:4px;">${buttons}</div>
      <button class="btn" style="margin-top:10px;background:#666;" onclick="showMainMenu()">Back</button>
    `;
  }

  function loadBg(filename) {
    fetch(`https://raw.githubusercontent.com/SolPhantomX/cryptobros/main/${filename}`)
      .then(res => res.blob())
      .then(blob => {
        const reader = new FileReader();
        reader.onload = () => setBgDataURL(reader.result);
        reader.readAsDataURL(blob);
      })
      .catch(() => alert(`File ${filename} not found`));
  }

  function showEditProfile() {
    document.getElementById('editMenu').innerHTML = `
      <input type="text" id="nameInput" value="${profileData.name}" placeholder="Name" />
      <div class="rank">Degen (Master)</div>
      <div class="field-label">About</div>
      <textarea id="aboutInput" placeholder="About">${profileData.about}</textarea>
      <div class="field-label">City</div>
      <input type="text" id="cityInput" value="${profileData.city}" placeholder="City" />
      <button class="btn" onclick="saveProfile()">Save</button>
      <button class="btn" style="background:#666;margin-left:10px;" onclick="showMainMenu()">Cancel</button>
    `;
  }

  function showMainMenu() {
    document.getElementById('editMenu').innerHTML = `
      <button onclick="showBgMenu()">Change Background</button>
      <button onclick="showEditProfile()">Edit Profile</button>
    `;
  }

  function saveProfile() {
    profileData = {
      name: document.getElementById('nameInput').value,
      about: document.getElementById('aboutInput').value,
      city: document.getElementById('cityInput').value
    };
    saveToStorage();
    renderProfile();
    showMainMenu();
  }

  function renderProfile() {
    document.getElementById('profileContent').innerHTML = `
      <div class="name">${profileData.name || '—'}</div>
      <div class="rank">Degen (Master)</div>
      <div class="field-label">About</div>
      <div class="field-value">${profileData.about || '—'}</div>
      <div class="field-label">City</div>
      <div class="field-value">${profileData.city || '—'}</div>
    `;
  }

  // Привязка к событиям
  document.addEventListener('DOMContentLoaded', init);
  window.addEventListener('load', () => {
    // Убедимся, что всё загружено
    if (document.getElementById('header')) {
      // уже сделано в init()
    }
  });

  // Глобальные функции для onclick
  window.showBgMenu = showBgMenu;
  window.showEditProfile = showEditProfile;
  window.showMainMenu = showMainMenu;
  window.saveProfile = saveProfile;
  window.loadBg = loadBg;
  window.setHeaderDataURL = setHeaderDataURL;
  window.setAvatarDataURL = setAvatarDataURL;
  window.setBgDataURL = setBgDataURL;
</script>

</body>
</html>
