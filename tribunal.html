<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRYPTOBROS TRIBUNAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;800&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background:#00052a;
      color:#00ff9d;
      min-height:100vh;
      padding:20px;
    }
    header { text-align:center; padding:30px 0; }
    h1 { font-family:'Poppins',sans-serif; font-size:2.8em; font-weight:800; text-shadow:0 0 10px #00ff9d; }
    .subtitle { font-size:1.2em; color:#66ffff; margin-top:8px; }
    .input-group { display:flex; max-width:600px; margin:0 auto 20px; gap:10px; }
    input { flex:1; padding:14px; background:rgba(0,5,42,0.9); border:2px solid #00ff9d; border-radius:10px; color:#00ff9d; font-size:1.1em; }
    input::placeholder { color:#66ffff; opacity:0.7; }
    button { padding:14px 30px; background:linear-gradient(135deg,#00ff9d,#66ffff); color:#000; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    .dialog { background:rgba(0,5,42,0.85); border:2px solid #66ffff; border-radius:12px; padding:20px; margin-bottom:30px; min-height:200px; }
    .dialog-title { font-size:1.4em; color:#66ffff; margin-bottom:15px; text-align:center; font-weight:700; }
    .message { margin:12px 0; padding:12px; border-left:4px solid #00ff9d; background:rgba(0,10,50,0.6); border-radius:6px; }
    .expert-name { font-weight:700; color:#66ffff; margin-bottom:4px; }
    .verdict { background:rgba(0,5,42,0.85); border:2px solid #d700ff; border-radius:12px; padding:20px; text-align:center; display:none; }
    .verdict-title { font-size:2em; margin-bottom:15px; text-shadow:0 0 10px #d700ff; font-weight:800; }
    .verdict-score { font-size:3.5em; font-weight:800; margin:15px 0; }
    .verdict-safe { color:#00ff9d; }
    .verdict-risk { color:#ff4d4d; }
    .details { background:rgba(0,0,0,0.4); padding:12px; border-radius:8px; margin-top:15px; white-space:pre-wrap; }
    footer { text-align:center; padding:20px; color:#66ffff; font-size:0.9em; }
  </style>
</head>
<body>
  <header>
    <h1>CRYPTOBROS TRIBUNAL</h1>
    <div class="subtitle">AI-Powered Risk Assessment</div>
  </header>

  <div class="input-group">
    <input type="text" id="tokenInput" placeholder="$TICKER or contract address" autocomplete="off">
    <button id="analyzeBtn">ANALYZE</button>
  </div>

  <div class="dialog" id="dialogSection">
    <div class="dialog-title">TRIBUNAL DELIBERATION</div>
    <div id="dialogContainer"></div>
  </div>

  <div class="verdict" id="verdictSection">
    <div class="verdict-title">FINAL VERDICT</div>
    <div id="verdictText" class="verdict-score"></div>
    <div id="verdictDetails" class="details"></div>
  </div>

  <footer>
    <p>Version 2.2 • Powered by GoPlusLabs • Premium required</p>
  </footer>

  <script>
    const tokenInput = document.getElementById('tokenInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const dialogContainer = document.getElementById('dialogContainer');
    const dialogSection = document.getElementById('dialogSection');
    const verdictSection = document.getElementById('verdictSection');
    const verdictText = document.getElementById('verdictText');
    const verdictDetails = document.getElementById('verdictDetails');

    analyzeBtn.addEventListener('click', analyzeToken);
    tokenInput.addEventListener('keypress', e => { if (e.key === 'Enter') analyzeToken(); });

    function addMessage(sender, text) {
      const div = document.createElement('div');
      div.className = 'message';
      div.innerHTML = `<div class="expert-name">[${sender}]</div>${text.replace(/\n/g, '<br>')}`;
      dialogContainer.appendChild(div);
      dialogContainer.scrollTop = dialogContainer.scrollHeight;
    }

    async function analyzeToken() {
      let query = tokenInput.value.trim();
      if (!query) return;

      dialogContainer.innerHTML = '';
      dialogSection.style.display = 'block';
      verdictSection.style.display = 'none';

      addMessage("System", "Initializing analysis...");

      let contractAddress = query.replace(/^\$/, '');
      let chain = 'solana';

      addMessage("System", `Using: ${contractAddress}`);

      const isPremium = localStorage.getItem('selectedTier') === 'Premium' || localStorage.getItem('selectedTier') === 'Pro';

      if (!isPremium) {
        addMessage("System", "Premium required for Quantum Scan.");
        verdictSection.style.display = 'block';
        verdictText.innerHTML = '<span class="verdict-risk">PREMIUM REQUIRED</span>';
        verdictDetails.innerHTML = 'Upgrade to Premium/Pro to unlock on-chain analysis.';
        return;
      }

      addMessage("Quantum Scanner", "Scanning contract...");

      try {
        const res = await fetch('https://cryptobros-backend.onrender.com/api/goplus/token-security', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chain_id: chain, contract_addresses: contractAddress })
        });

        if (!res.ok) throw new Error(`Backend error: ${res.status}`);

        const data = await res.json();
        const result = data.result[contractAddress.toLowerCase()] || data.result[Object.keys(data.result)[0]] || {};

        let risk = 5;
        let details = "QUANTUM SCAN COMPLETE\n\n";

        if (result.is_honeypot === '1') risk += 90, details += "→ Honeypot DETECTED (CRITICAL)\n";
        if ((result.buy_tax || 0) > 5 || (result.sell_tax || 0) > 5) risk += 40, details += `→ Taxes: ${result.buy_tax || 0}% / ${result.sell_tax || 0}%\n`;
        if (result.is_proxy === '1') risk += 70, details += "→ Proxy (RUG RISK)\n";
        if (result.can_take_back_ownership === '1') risk += 60, details += "→ Ownership recovery ENABLED\n";
        if (result.is_open_source === '0') risk += 40, details += "→ Closed source\n";
        if (result.is_anti_whale === '0') risk += 25, details += "→ No anti-whale\n";

        risk = Math.min(99, risk);
        details += `\nRisk Score: ${risk.toFixed(0)}%`;

        addMessage("Phi-3-mini (Moderator)", details);
        showVerdict(risk, details);

      } catch (err) {
        addMessage("System", `Scan failed: ${err.message}`);
        showVerdict(99, "Scan error. Try again.");
      }
    }

    function showVerdict(risk, details) {
      verdictSection.style.display = 'block';
      const percent = risk.toFixed(0);
      let html = percent <= 20 ? `TRUSTED (${percent}%)` : percent <= 50 ? `LOW RISK (${percent}%)` : `HIGH RISK (${percent}%)`;
      let color = percent <= 20 ? 'verdict-safe' : 'verdict-risk';

      verdictText.innerHTML = `<span class="${color}">${html}</span>`;
      verdictDetails.innerHTML = `<pre>${details}</pre>`;
    }
  </script>
</body>
</html>
